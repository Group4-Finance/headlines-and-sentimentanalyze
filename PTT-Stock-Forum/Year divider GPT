import os
import pandas as pd

# ğŸ“‚ Step 1: Set your input and output folders
# âœ… Use raw string (r"...") to avoid issues with backslashes in Windows paths
input_folder = r"C:/Users/YourName/Documents/csv_input"
output_folder = r"C:/Users/YourName/Documents/csv_output"

# ğŸ› ï¸ Step 2: Create the output folder if it doesn't exist
os.makedirs(output_folder, exist_ok=True)

# ğŸ“¦ Step 3: Create a dictionary to store rows grouped by year
yearly_data = {}

# ğŸ“„ Step 4: Loop through all CSV files in the input folder
for filename in os.listdir(input_folder):
    if filename.endswith(".csv"):
        filepath = os.path.join(input_folder, filename)
        print(f"ğŸ” Reading file: {filename}")

        # ğŸ“¥ Read the CSV file (try utf-8 first, or change to 'big5' if needed)
        try:
            df = pd.read_csv(filepath, encoding='utf-8')
        except UnicodeDecodeError:
            df = pd.read_csv(filepath, encoding='big5')

        # ğŸ—“ï¸ Step 5: Convert the æ—¥æœŸ column to datetime format
        df['æ—¥æœŸ'] = pd.to_datetime(df['æ—¥æœŸ'], format='%Y/%m/%d', errors='coerce')

        # ğŸ§¹ Remove rows with invalid or missing dates
        df = df.dropna(subset=['æ—¥æœŸ'])

        # ğŸ“† Step 6: Group data by year
        for year in df['æ—¥æœŸ'].dt.year.unique():
            year_df = df[df['æ—¥æœŸ'].dt.year == year]
            if year in yearly_data:
                yearly_data[year] = pd.concat([yearly_data[year], year_df], ignore_index=True)
            else:
                yearly_data[year] = year_df

# ğŸ’¾ Step 7: Save each year's data as a separate CSV file
for year, data in yearly_data.items():
    output_path = os.path.join(output_folder, f"{year}.csv")
    data.to_csv(output_path, index=False, encoding='utf-8-sig')  # utf-8-sig works well with Chinese
    print(f"âœ… Saved: {output_path}")

print("ğŸ‰ Done! All files have been split and saved by year.")
